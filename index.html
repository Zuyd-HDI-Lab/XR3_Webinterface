<!-- Version: 18:33 29-10-2020 -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>VR Research Reporter - Main</title>

    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:400,700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="/data/participantlist.js"></script>
    <script type="text/javascript" src="/js/participantIndex.js"></script>
</head>

<body>
    <div id="divPartSelection">
        <h1>Welcome Researcher</h1>
        <div id="rb_partlist">
            <p>Select participant:</p>
        </div>
        <button id="btnAnalyse" type="button">Analyse</button>
        <button id="btnDownloadAll" type="button">Download All</button>
        <button id="btnDownloadSelected" type="button">Download Selected</button>
    </div>
    <script>
        var selectedParticipants = partlist;
        let params = new URLSearchParams(window.location.search);
        let sp_param = params.get('sp') 
        if (sp_param != null){            
            selectedParticipants = sp_param.split(',');
        }
        console.log(selectedParticipants)

        fileList = openCSVFiles(partlist);
        Promise.all(fileList)            
        .then(function (part_details) {
            var partInfoList = createPartInfo(part_details);
            
            table = d3.select("#rb_partlist").append('table')
                .style("border-collapse", "collapse")
                .style("border", "2px black solid");

            // headers
            table.append("thead").append("tr")
                .selectAll("th")
                .data(partInfoList[0])
                .enter().append("th")
                .attr("class","partList_header")
                .text(function(d) { return d; })

            // data
            table.append("tbody")
                .selectAll("tr").data(partInfoList.slice(1))
                .enter().append("tr")
                .attr("id", function(d){return d[1]})
                .selectAll("td")
                .data(function(d){return d;})
                .enter().append("td")
                //.attr("name",function(d){return d})
                .attr("class",function(d){return d})
                .text(function(d){return d })
                
           //Add checkboxes after last colomn
           d3.select("tbody").selectAll("tr")
                .append("td").append("input")
                .attr("type","checkbox")
                .attr("id", "downloadBox")
                .attr("value", function(d){return this.parentNode.parentNode.id})
                .attr("checked", function(d){
                    console.log(this.parentNode.parentNode.id)
                    console.log(selectedParticipants)
                    if (selectedParticipants.indexOf(this.parentNode.parentNode.id) != -1){
                        return "true";
                    } 
                    else return null;
                });

            //Highlight selectedRow 
            let selectedParticipant = "002";              
            var tr = table.selectAll("tr")
                .on("click", function(d) {
                    console.log(d)
                    console.log(d.srcElement.parentNode.id)
                    if (d.srcElement.id != "downloadBox"){
                        tr.classed("selectedRow", false);
                        d3.select(d.srcElement.parentNode).classed("selectedRow", true);
                        selectedParticipant = d.srcElement.parentNode.id;
                    }
                    else{
                        if (d.srcElement.checked){
                            selectedParticipants.push(d.srcElement.parentNode.parentNode.id)
                        }
                        else{
                            const index = selectedParticipants.indexOf(d.srcElement.parentNode.parentNode.id);
                            if (index > -1) selectedParticipants.splice(index, 1);
                        }
                    }
            });          
             
            document.querySelector('#btnAnalyse').addEventListener("click", () => { 
                const url = new URL(window.location);
                url.searchParams.set('sp', selectedParticipants);
                window.history.replaceState({}, '', url);
                window.location.href="vr3.html?partid="+ selectedParticipant;
            });
            document.querySelector('#btnDownloadAll').addEventListener("click", () => {
                combinedFile = createCombinedFile(partlist); 
            });
            document.querySelector('#btnDownloadSelected').addEventListener("click", () => { 
                console.log("TODO: Download selected data for: ",selectedParticipants);
                combinedFile = createCombinedFile(selectedParticipants); 
            });

        }).catch(function (error) { console.log(error);});
    </script>
</body>